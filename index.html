<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ШАГАЙ ДОМА · Квиз-калькулятор</title>
  <meta name="description" content="Узнайте, за сколько недель шагательные тренировки помогут вам похудеть." />
  <meta name="color-scheme" content="light only" />

  <!-- Предзагрузка видео для ускоренного старта -->
  <link rel="preload" as="video" href="intro.mp4" type="video/mp4" fetchpriority="high">

  <style>
    :root{ --r:#CF2C02; --y:#FFBA08; --o:#E85D04; --g:#D9D9D9; --txt:#1a1a1a;
           --hero-pos-y:28%; --hero-pos-y-m:22%; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--txt); background:#fff; overflow-x:hidden }

    .app{ width:min(960px,100%); margin:0 auto; padding:16px }
    .card{ background:#fff; border-radius:22px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:18px }

    /* HERO контейнер и видео */
    .hero-wrap{ position:relative; margin:0 0 12px 0; border-radius:20px; overflow:hidden; box-shadow:0 10px 18px rgba(0,0,0,.08) }
    .hero-media{
      display:block; width:100%; height:auto;
      aspect-ratio:16/9; object-fit:cover; object-position:50% var(--hero-pos-y); border-radius:20px;
    }
    @media (max-width:480px){ .hero-media{ object-position:50% var(--hero-pos-y-m) } }

    /* Скелетон до готовности видео */
    .hero-skel{
      position:absolute; inset:0; border-radius:20px;
      background:linear-gradient(110deg, #f4f4f4 8%, #eaeaea 18%, #f4f4f4 33%);
      background-size:200% 100%; animation:heroShimmer 1.2s linear infinite;
    }
    @keyframes heroShimmer{ to{ background-position-x:-200% } }
    .hero-skel.hide{ opacity:0; pointer-events:none; transition:opacity .25s ease }

    /* Экраны */
    .screen{ display:none; animation:.35s fs ease both }
    .screen.is{ display:block }
    @keyframes fs{ from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:translateY(0)} }

    .hint{ color:#6b6b6b; font-size:.9rem }
    .grid{ display:grid; gap:12px }
    .cols2{ grid-template-columns:1fr 1fr }
    @media (max-width:620px){ .cols2{ grid-template-columns:1fr } }

    .opt{ border:2px solid var(--g); border-radius:14px; padding:12px; display:flex; gap:10px; align-items:center; background:#fff; cursor:pointer; transition:.2s }
    .opt.is{ border-color:var(--o); box-shadow:0 6px 16px rgba(232,93,4,.12) }

    /* Телосложение — карточки с картинками */
    .opt--img{ flex-direction:column; align-items:center; text-align:center; padding:10px }
    .opt--img img{ width:100%; height:180px; object-fit:contain; background:#fafafa; border-radius:12px }
    .opt--img span{ margin-top:8px; font-weight:600 }

    .chips{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{ border:2px solid var(--g); border-radius:999px; padding:8px 12px; background:#fff; cursor:pointer }
    .chip.is{ border-color:var(--o); box-shadow:0 6px 16px rgba(232,93,4,.12) }

    .text{ width:100%; border:2px solid var(--g); border-radius:12px; padding:10px 12px; font-size:1rem }

    .actions{ display:flex; gap:8px; margin-top:14px }
    .btn{ border:none; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer }
    .primary{ background:linear-gradient(135deg,var(--r),var(--o)); color:#fff; box-shadow:0 10px 18px rgba(207,44,2,.25) }
    .ghost{ background:#fff; border:2px solid var(--g) }

    .sticky{ position:sticky; bottom:0; background:linear-gradient(0deg,#fff 70%,rgba(255,255,255,0)); padding-top:8px; z-index:9 }

    /* Новый экран загрузки результата */
    .loader2{ display:flex; flex-direction:column; align-items:center; text-align:center; padding:28px 8px 12px }
    .loader2 .ring{
      --p:0%;
      width:88px; height:88px; border-radius:50%;
      background: conic-gradient(var(--o) var(--p), #eee 0);
      position:relative; box-shadow:0 8px 20px rgba(0,0,0,.08);
    }
    .loader2 .ring::after{ content:""; position:absolute; inset:10px; background:#fff; border-radius:50% }
    .loader2 .pct{ position:absolute; inset:0; display:grid; place-items:center; font-weight:800 }
    .loader2 .lmsg{ margin-top:14px; font-weight:700; font-size:1.05rem }

    /* Экран результата — крупные цифры */
    .counter{ font-size:clamp(26px,6vw,48px); line-height:1.15; letter-spacing:-.02em; text-wrap:balance }

    /* Продукты (старые боксы — оставлены на всякий) */
    .box{ border:2px solid var(--y); border-radius:14px; padding:12px; margin:8px 0 }
    .box h3{ margin:.2rem 0 .6rem 0 }

    /* Круговой прогресс + логотип */
    #progress{
      position:relative; height:auto; margin:0 0 12px;
      display:flex; align-items:center; gap:10px;
    }
    #progress.hide{ display:none !important; }
    #progress .pcirc{
      --p:0%;
      width:56px; height:56px; border-radius:50%;
      background: conic-gradient(var(--o) var(--p), #eee 0);
      position:relative; display:inline-grid; place-items:center;
      box-shadow:0 6px 16px rgba(0,0,0,.08); transition:background .15s linear;
      flex:0 0 56px;
    }
    #progress .pcirc::after{ content:""; width:44px; height:44px; border-radius:50%; background:#fff; position:absolute }
    #progress .pct{ position:relative; z-index:1; font-size:.9rem; font-weight:800; letter-spacing:-.02em }
    #progress .plogo{ margin-left:auto; display:flex; align-items:center; flex:0 0 auto }
    #progress .plogo img{ height:32px; width:auto; display:block; object-fit:contain }
    @media (max-width:480px){ #progress .plogo img{ height:28px } }

    /* RANGE: большой красный ползунок */
    #steps{
      --pct: 0%;
      --track:#e9e9e9; --fill-start:var(--r); --fill-end:var(--o);
      width:100%; height:40px; background:transparent; accent-color:var(--o);
    }
    #steps:focus{ outline:none }
    /* WebKit */
    #steps::-webkit-slider-runnable-track{
      height:12px; border-radius:999px;
      background:linear-gradient(90deg,var(--fill-start) 0 var(--pct), var(--track) var(--pct) 100%);
      box-shadow:inset 0 1px 2px rgba(0,0,0,.08);
    }
    #steps::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:28px; height:28px; border-radius:50%; background:#fff; border:3px solid var(--o);
      box-shadow:0 4px 10px rgba(232,93,4,.25); margin-top:-8px; transition:transform .12s ease;
    }
    #steps:active::-webkit-slider-thumb{ transform:scale(1.06) }
    /* Firefox */
    #steps::-moz-range-track{ height:12px; border-radius:999px; background:var(--track); box-shadow:inset 0 1px 2px rgba(0,0,0,.08) }
    #steps::-moz-range-progress{ height:12px; border-radius:999px; background:linear-gradient(135deg,var(--fill-start),var(--fill-end)) }
    #steps::-moz-range-thumb{
      width:28px; height:28px; border-radius:50%; background:#fff; border:3px solid var(--o);
      box-shadow:0 4px 10px rgba(232,93,4,.25); transition:transform .12s ease;
    }
    #steps:active::-moz-range-thumb{ transform:scale(1.06) }

    /* BMI tag */
    .bmi-line{ margin-top:6px }
    .bmi-tag{ display:inline-block; padding:4px 8px; border-radius:999px; font-weight:700; font-size:.9rem; vertical-align:baseline }
    .bmi-ok{   background:#e8f7ee; color:#0f7a42 }
    .bmi-warn{ background:#fff4e6; color:#a04b00 }
    .bmi-bad{  background:#ffe8e6; color:#a11000 }

    /* ===== Экран «Привычки и продукты» — вау-версия ===== */
    .habit{ display:grid; gap:14px }
    .habit-grid{ display:grid; gap:12px; grid-template-columns:1fr 1fr }
    @media (max-width:720px){ .habit-grid{ grid-template-columns:1fr } }

    .habit h3{ margin:.2rem 0 .6rem 0; font-size:1.02rem }
    .habit .col{ border:2px solid var(--g); border-radius:14px; padding:12px; background:#fff }

    .chips--pills{ gap:10px }
    .chips--pills .chip{
      border-radius:999px; padding:10px 14px; font-weight:600;
      border:2px solid var(--g); background:#fff; position:relative;
      transition:transform .08s ease, border-color .15s ease, box-shadow .15s ease, background .2s ease, color .2s ease;
    }
    .chips--pills .chip[data-kind="bad"]{ border-color:#ffd7cf }
    .chips--pills .chip[data-kind="good"]{ border-color:#cfeede }

    .chips--pills .chip.is{ transform:translateY(-1px) scale(1.02); color:#111 }
    .chips--pills .chip[data-kind="bad"].is{
      background:linear-gradient(135deg,#ffe9e3,#ffd3c9);
      border-color:#ffb5a5; box-shadow:0 6px 16px rgba(255,115,97,.18);
    }
    .chips--pills .chip[data-kind="good"].is{
      background:linear-gradient(135deg,#e9f9f0,#d5f1e6);
      border-color:#bfe7d6; box-shadow:0 6px 16px rgba(21,178,116,.16);
    }
    .chips--pills .chip.is::after{
      content:"✓"; position:absolute; top:-8px; right:-8px;
      width:22px; height:22px; border-radius:50%;
      display:grid; place-items:center; font-weight:800; font-size:.85rem;
      background:#fff; border:2px solid #ddd; box-shadow:0 2px 8px rgba(0,0,0,.1);
    }

    .habit-meter{ border:2px solid var(--g); border-radius:14px; padding:12px; background:#fff }
    .hm-top{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px }
    #hmLabel{ font-weight:700 }
    #hmScore{ font-weight:800 }
    .hm-track{
      --p:50%;
      position:relative; height:14px; border-radius:999px; overflow:hidden;
      background:linear-gradient(90deg,#ffe1db 0%,#fff7e8 50%,#e7f7ef 100%);
      box-shadow:inset 0 1px 2px rgba(0,0,0,.08);
    }
    .hm-pointer{
      position:absolute; top:50%; left:var(--p); transform:translate(-50%,-50%);
      width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid var(--o);
      box-shadow:0 4px 12px rgba(0,0,0,.12); transition:left .25s ease, border-color .2s ease;
    }
    .hm-scale{ display:flex; justify-content:space-between; font-size:.82rem; color:#666; margin-top:6px }
    .hm-badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-weight:700; font-size:.85rem; margin-left:8px }
    .hm-bad{ background:#ffe9e6; color:#a11000 }
    .hm-ok{  background:#fff3cc; color:#9a6b00 }
    .hm-good{background:#e7f7ef; color:#0f7a42 }

    /* Изображение на продающем экране */
    .sale-hero{ margin:0 0 12px 0; border-radius:16px; overflow:hidden }
    .sale-hero img{ width:100%; display:block; border-radius:16px; object-fit:cover }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div id="progress"></div>
      <div id="screens"></div>
    </div>
  </div>

  <script>
    const $  = s => document.querySelector(s);
    const $$ = (s, root=document) => Array.from((root||document).querySelectorAll(s)); // поддержка root
    const vibrate = n => { try{ navigator.vibrate && navigator.vibrate(n||12) }catch(e){} };

    // Данные
    const A = JSON.parse(localStorage.getItem('sdq')||'{}');
    const save = () => localStorage.setItem('sdq', JSON.stringify(A));

    // Справочники
    const AGE=['18–29','30–39','40–49','50+'];
    const BODY=[
      {label:'Худощавое', key:'slim',   img:'skinny.png', alt:'Худощавое телосложение'},
      {label:'Среднее',   key:'avg',    img:'slim.png',   alt:'Среднее телосложение'},
      {label:'Крупное',   key:'large',  img:'medium.png', alt:'Крупное телосложение'},
      {label:'Избыточный вес', key:'obese', img:'xl.png', alt:'Избыточный вес'}
    ];
    const LIFE=['Сидячая работа','Умеренно активная','Активная'];
    const EXP=['Никогда не занималась','Иногда дома / по видео','Регулярно'];
    const GOAL=['Сбросить 3–5 кг','Сбросить 5–10 кг','Сбросить 10+ кг','Поддерживать фигуру / вернуть тонус'];
    const MOT=['Для здоровья','Для внешности','Для энергии и лёгкости','Для уверенности в себе'];
    const HARD=['Долгая прогулка утомляет','Каждый пролёт по лестнице — испытание','Стыдно включаться в активные игры','Прыжки','Ничего из этого'];
    const HEALTH=['Диабет','Проблемы со щитовидкой','Гипертония','Боль в суставах','Беременность','Нет'];
    const BAD=['Сладкая газировка','Выпечка','Фастфуд','Колбаса/сосиски','Сыр 45%+','Ночные перекусы','Алкоголь чаще 2 р/нед','Сладкий чай/кофе','Очень солёная пища'];
    const GOOD=['1.5–2 л воды','Овощи 400 г/день','Фрукты ежедневно','Белок в каждом приёме пищи','10–20 мин растяжки','8 000+ шагов уже сейчас'];

    // Разметка экранов
    const screensRoot = $('#screens');
    const section = (id,html)=>`<section class="screen${id==='intro'?' is':''}" data-id="${id}">${html}</section>`;
    const chips = (id,arr)=>`<div class="chips" id="${id}">`+arr.map(t=>`<button type="button" class="chip" data-v="${t}">${t}</button>`).join('')+`</div>`;
    const opts = (id,arr)=>`<div class="grid cols2" id="${id}">`+
      arr.map(t=>{
        let label,key;
        if (typeof t==='string'){ label=t; key=t; }
        else if (Array.isArray(t)){ label=t[0]; key=(t[1]??t[0]); }
        else if (t && typeof t==='object'){ label=t.label ?? t.value ?? t.key ?? ''; key=t.key ?? t.value ?? t.label ?? ''; }
        else { label=String(t); key=String(t); }
        return `<label class="opt" data-v="${String(key)}"><span>${String(label)}</span></label>`;
      }).join('')+`</div>`;
    const actions = ()=>`<div class="actions sticky"><button class="btn ghost" data-prev>Назад</button><button class="btn primary" data-next>Далее</button></div>`;

    const html =
      section('intro', `
        <figure class="hero-wrap">
          <div class="hero-skel" id="heroSkel"></div>
          <video class="hero-media" autoplay muted loop playsinline preload="auto">
            <source src="intro.mp4#t=0.1" type="video/mp4" />
            <img src="logo.png" alt="ШАГАЙ ДОМА" />
          </video>
        </figure>
        <h1>Узнайте, за сколько недель шагательные тренировки помогут вам похудеть</h1>
        <p class="hint">Ответьте на несколько вопросов — это займёт 1–2 минуты.</p>
        <div class="grid"><div><div class="hint">Как к вам обращаться?</div><input id="name" class="text" placeholder="Например: Ирина"></div></div>
        <div class="actions sticky"><button class="btn primary" id="start" type="button" data-next>Поехали →</button></div>
      `)
      + section('age', `<h2>Ваш возраст</h2>${opts('ageOpts', AGE)}${actions()}`)
      + section('body', `
        <h2>Телосложение сейчас</h2>
        <div class="grid cols2" id="bodyOpts">
          ${BODY.map(o => `
            <label class="opt opt--img" data-v="${o.key}">
              <img src="${o.img}" alt="${o.alt}">
              <span>${o.label}</span>
            </label>
          `).join('')}
        </div>
        ${actions()}
      `)
      + section('steps', `
        <h2>Сколько шагов вы проходите сейчас в день (примерно)?</h2>
        <input id="steps" type="range" min="0" max="25000" step="250" value="4000">
        <div class="hint">Сейчас: <b><span id="sv">4000</span> шагов</b></div>
        <p class="hint"><b>Подсказка:</b> найти шаги можно в приложении вашего телефона/браслета</p>
        ${actions()}
      `)
      + section('bmi', `
        <h2>Давайте посчитаем ваш ИМТ</h2>
        <p class="hint">Укажите ваш рост и вес — можно приблизительно.</p>
        <div class="grid cols2">
          <div><div class="hint">Рост, см</div><input id="h" type="number" class="text" placeholder="Например: 165"></div>
          <div><div class="hint">Вес, кг</div><input id="w" type="number" class="text" placeholder="Например: 72"></div>
        </div>
        <div id="bmiI" class="hint"></div>
        ${actions()}
      `)
      + section('life', `<h2>Образ жизни</h2>${opts('lifeOpts', LIFE)}${actions()}`)
      + section('exp',  `<h2>Опыт тренировок</h2>${opts('expOpts', EXP)}${actions()}`)
      + section('goal', `<h2>Ваша цель</h2>${opts('goalOpts', GOAL)}${actions()}`)
      + section('motivation', `<h2>Почему вы хотите заниматься спортом?</h2>${chips('motChips', MOT)}${actions()}`)
      + section('perweek', `<h2>Сколько готовы тренироваться в неделю?</h2>${chips('pwChips', ['2 раза','3 раза','4–5 раз','Каждый день 20–30 мин'])}${actions()}`)
      + section('hard', `<h2>Что сейчас даётся тяжелее всего?</h2>${opts('hardOpts', HARD)}${actions()}`)
      + section('health', `<h2>Есть ли состояния, которые важно учитывать?</h2>${chips('healthChips', HEALTH)}<p class="hint">Если есть сомнения — проконсультируйтесь с врачом.</p>${actions()}`)
      + section('nutrition', `<h2>Питание</h2>${opts('nutriOpts', [
          {label:'Буду питаться по меню-конструктору в клубе',key:'menu'},
          {label:'Хочу научиться правильно составлять тарелку',key:'plate'},
          {label:'Нет, пока без питания',key:'no'}
        ])}${actions()}`)
      + section('food', `
        <h2>Привычки и продукты</h2>
        <div class="habit">
          <div class="habit-grid">
            <div class="col">
              <h3>Тормозит прогресс</h3>
              <div class="chips chips--pills" id="bad">
                ${BAD.map(x=>`<button type="button" class="chip" data-kind="bad" data-v="${x}">${x}</button>`).join('')}
              </div>
            </div>
            <div class="col">
              <h3>Ускоряет результат</h3>
              <div class="chips chips--pills" id="good">
                ${GOOD.map(x=>`<button type="button" class="chip" data-kind="good" data-v="${x}">${x}</button>`).join('')}
              </div>
            </div>
          </div>

          <div class="habit-meter">
            <div class="hm-top">
              <div>
                <span id="hmLabel">Индекс прогресса</span>
                <span class="hm-badge hm-ok" id="hmBadge">нейтрально</span>
              </div>
              <span id="hmScore">0%</span>
            </div>
            <div class="hm-track" id="hmTrack">
              <div class="hm-pointer" id="hmPtr"></div>
            </div>
            <div class="hm-scale"><span>тормозит</span><span>нейтрально</span><span>ускоряет</span></div>
          </div>

          <p class="hint">Отмечайте то, что про вас — индикатор обновляется в реальном времени ✨</p>

          <div class="actions sticky">
            <button class="btn ghost" data-prev>Назад</button>
            <button class="btn primary" id="calc">Рассчитать результат →</button>
          </div>
        </div>
      `)
      + section('loading', `
        <div class="loader2">
          <div class="ring" id="lring"><div class="pct" id="lpct">0%</div></div>
          <div class="lmsg" id="lmsg">Собираем данные…</div>
          <p class="hint" id="lsub">Возраст • ИМТ • Активность • Цель</p>
        </div>
      `)
      + section('result', `
        <h2 id="rTitle">Готово!</h2>
        <div class="counter" id="nums">0 кг за 0 недель</div>
        <p class="hint" id="rSub"></p>
        <p class="hint" id="rDisc">Прогноз носит ознакомительный характер и не является медицинской рекомендацией.</p>
        <div class="actions sticky"><button class="btn ghost" data-prev>Назад</button><button class="btn primary" id="toCTA">Хочу такой результат!</button></div>
      `)
      + section('sale', `
        <figure class="sale-hero">
          <img src="final.PNG" alt="Результаты участниц и атмосфера клуба «ШАГАЙ ДОМА»">
        </figure>
        <h2 id="sTitle">Присоединяйтесь к клубу «ШАГАЙ ДОМА» ⚡</h2>
        <p class="hint" id="sLead"></p>
        <ul>
          <li>Домашние шагательные тренировки 20–30 минут</li>
          <li>Готовые планы на неделю</li>
          <li>Поддержка и мотивация в чате</li>
          <li>Без прыжков и сложной хореографии</li>
        </ul>
        <div class="actions"><a class="btn primary" id="cta" href="#" target="_blank" rel="noopener">Получить абонемент со скидкой</a><button class="btn ghost" data-prev>Назад</button></div>
      `);

    screensRoot.innerHTML = html;

  /* Прогресс-бар (круг + процент) + логотип справа */
    const progress = $('#progress');
    progress.innerHTML = `
      <div class="pcirc"><div class="pct">0%</div></div>
      <div class="plogo"><img src="logo.png" alt="ШАГАЙ ДОМА"></div>
    `;
    const pcirc  = () => $('#progress .pcirc');
    const pcText = () => $('#progress .pct');

    let pctNow = 0, rafId = 0;
    function animateProgress(to){
      cancelAnimationFrame(rafId);
      const stiffness = 0.08, damping = 0.75;
      let v = 0;
      function frame(){
        const x = pctNow - to, a = -stiffness * x;
        v = (v + a) * damping; pctNow += v;
        if (Math.abs(pctNow - to) < 0.3 && Math.abs(v) < 0.3) pctNow = to;
        pcirc().style.setProperty('--p', pctNow.toFixed(1) + '%');
        pcText().textContent = Math.round(pctNow) + '%';
        if (pctNow !== to) rafId = requestAnimationFrame(frame);
      }
      rafId = requestAnimationFrame(frame);
    }

    /* Навигация */
    let idx=0; const S=$$('#screens .screen'); const need=k=>!A[k];
    function setProgress(i){
      progress.classList.toggle('hide', i===0);  // прячем на intro без зазора
      const total = S.length - 1;
      const pct = Math.round((i/total)*100);
      animateProgress(pct);
    }
    function show(n){
      S[idx].classList.remove('is');
      idx=Math.max(0,Math.min(S.length-1,n));
      S[idx].classList.add('is');
      setProgress(idx);
      scrollTo({top:0,behavior:'smooth'});
    }
    setProgress(0);

    addEventListener('click', e=>{
      const next=e.target.closest('[data-next]'); const prev=e.target.closest('[data-prev]');
      if(next){ vibrate(); goNext(); }
      if(prev){ vibrate(); show(idx-1); }
    });
    function shake(){ S[idx].animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:260}); vibrate(25); }
    function goNext(){
      const id=S[idx].dataset.id;
      if(id==='age'&&need('age'))return shake();
      if(id==='body'&&need('body'))return shake();
      if(id==='bmi'&&(!A.h||!A.w))return shake();
      if(id==='life'&&need('life'))return shake();
      if(id==='exp'&&need('exp'))return shake();
      if(id==='goal'&&need('goal'))return shake();
      if(id==='perweek'&&need('perweek'))return shake();
      show(idx+1);
    }

    /* Привязки полей */
    $('#name').oninput = e=>{ A.name=e.target.value.trim(); save(); };

    const steps=$('#steps'), sv=$('#sv');
    function updateRangeBG(){
      const min=+steps.min||0, max=+steps.max||100, val=+steps.value||0;
      const pct=((val-min)/(max-min))*100; steps.style.setProperty('--pct', pct+'%');
    }
    steps.oninput=e=>{ A.steps=+e.target.value; sv.textContent=A.steps; updateRangeBG(); save(); };

    ['h','w'].forEach(id=>{ $('#'+id).oninput = updateBMI; });
    function bmiCategory(bmi){
      if (bmi < 18.5) return {label:'Дефицит массы', cls:'bmi-warn', note:'ниже нормы (18,5–24,9)'};
      if (bmi < 25)   return {label:'Норма',          cls:'bmi-ok',   note:'в пределах нормы (18,5–24,9)'};
      if (bmi < 30)   return {label:'Избыточная масса',cls:'bmi-warn', note:'выше нормы'};
      if (bmi < 35)   return {label:'Ожирение I ст.',  cls:'bmi-bad',  note:'значительно выше нормы'};
      if (bmi < 40)   return {label:'Ожирение II ст.', cls:'bmi-bad',  note:'значительно выше нормы'};
      return            {label:'Ожирение III ст.',     cls:'bmi-bad',  note:'значительно выше нормы'};
    }
    function updateBMI(){
      const h=+$('#h').value, w=+$('#w').value;
      if (h>0 && w>0){
        A.h=h; A.w=w; const m=h/100; A.bmi=+(w/(m*m)).toFixed(1); save();
        const cat=bmiCategory(A.bmi);
        $('#bmiI').innerHTML =
          `Ваш ИМТ: <b>${A.bmi}</b> <span class="bmi-tag ${cat.cls}">${cat.label}</span>` +
          `<br><span class="hint bmi-line">ИМТ помогает ориентироваться в массе тела; норма для взрослых — 18,5–24,9. Помните, что на результат влияют особенности телосложения, беременность и выраженная мышечная масса.</span>`;
      } else { $('#bmiI').textContent=''; }
    }

    function selectList(root,key,single){
      root.addEventListener('click',e=>{
        const sel=e.target.closest(single?'.opt':'.chip'); if(!sel) return;
        if(single){
          $$('.opt',root).forEach(x=>x.classList.remove('is'));
          sel.classList.add('is'); A[key]=sel.dataset.v||sel.textContent;
        } else {
          sel.classList.toggle('is');
          A[key]=$$('.chip.is',root).map(x=>x.dataset.v||x.textContent);
        }
        save(); vibrate(8);
      });
    }

    selectList($('#ageOpts'),'age',true);
    selectList($('#bodyOpts'),'body',true);
    selectList($('#lifeOpts'),'life',true);
    selectList($('#expOpts'),'exp',true);
    selectList($('#goalOpts'),'goal',true);
    selectList($('#motChips'),'mot',false);
    selectList($('#pwChips'),'perweek',false);
    selectList($('#hardOpts'),'hard',true);
    selectList($('#healthChips'),'health',false);
    selectList($('#bad'),'bad',false);
    selectList($('#good'),'good',false);
    selectList($('#nutriOpts'),'nutri',true);

    /* ===== Индикатор привычек (вау-экран) ===== */
    function nutritionFactorPreview(){
      const b = (A.bad||[]).length;
      const g = (A.good||[]).length;
      let f = 1;
      f += g * 0.02;  // хорошие +2% за штуку
      f -= b * 0.03;  // вредные -3% за штуку
      f = Math.max(.7, Math.min(1.35, f));
      return f;
    }
    function updateHabitMeter(){
      const f = nutritionFactorPreview();
      const accel = Math.round((f - 1) * 100);
      const ptr = $('#hmPtr'), track = $('#hmTrack'), score = $('#hmScore'), badge = $('#hmBadge');
      const min=-30, max=35;
      const clamp = Math.max(min, Math.min(max, accel));
      const p = ((clamp - min) / (max - min)) * 100;
      track.style.setProperty('--p', p + '%');
      ptr.style.left = p + '%';
      score.textContent = (accel>0?'+':'') + accel + '%';
      let cls='hm-ok', txt='нейтрально', border='#FFBA08';
      if(accel <= -15){ cls='hm-bad'; txt='сильно тормозит'; border='#E85D04'; }
      else if(accel < -5){ cls='hm-bad'; txt='тормозит'; border='#E85D04'; }
      else if(accel > 15){ cls='hm-good'; txt='суперускорение'; border='#12A06A'; }
      else if(accel > 5){ cls='hm-good'; txt='ускоряет'; border='#12A06A'; }
      else { cls='hm-ok'; txt='нейтрально'; border='#FFBA08'; }
      badge.className = 'hm-badge ' + cls;
      badge.textContent = txt;
      ptr.style.borderColor = border;
    }
    function setupHabitMeter(){
      ['bad','good'].forEach(id=>{
        const el = $('#'+id);
        if(!el) return;
        el.addEventListener('click', ()=> setTimeout(updateHabitMeter, 0), true);
      });
      function restoreChips(id, key){
        const sel = new Set(A[key]||[]);
        $$('#'+id+' .chip').forEach(ch=>{
          const v = ch.dataset.v || ch.textContent;
          if(sel.has(v)) ch.classList.add('is');
        });
      }
      restoreChips('bad','bad');
      restoreChips('good','good');
      updateHabitMeter();
    }
    setupHabitMeter();

    /* Экран загрузки — анимация и смена фраз */
    function runLoading(done){
      const ring = $('#lring'), lpct = $('#lpct'), lmsg = $('#lmsg'), lsub = $('#lsub');
      const stepsTxt = [
        'Учитываем ваш возраст',
        'Смотрим телосложение и ИМТ',
        'Проверяем активность и опыт',
        'Добавляем шаги и питание',
        'Готовим персональный прогноз…'
      ];
      let si = 0; lmsg.textContent = stepsTxt[0]; lsub.textContent = 'Возраст • ИМТ • Активность • Цель';
      const D = 1500, t0 = performance.now();
      function tick(now){
        const p = Math.min(1, (now - t0)/D), ease = 1 - Math.pow(1 - p, 3);
        const pct = Math.round(5 + 95 * ease);
        ring.style.setProperty('--p', pct + '%'); lpct.textContent = pct + '%';
        const idx = Math.min(stepsTxt.length - 1, Math.floor(p * stepsTxt.length));
        if(idx !== si){ si = idx; lmsg.textContent = stepsTxt[si]; }
        if(p < 1) requestAnimationFrame(tick); else setTimeout(()=>done(), 200);
      }
      requestAnimationFrame(tick);
    }

    // Калькуляция
    const idxBy = id => $$('#screens .screen').findIndex(s=>s.dataset.id===id);
    $('#calc').onclick = ()=>{ show(idx+1); runLoading(calculate); };

    function goalKg(){ const g=A.goal||''; if(g.includes('3–5'))return 4; if(g.includes('5–10'))return 8; if(g.includes('10+'))return 12; return 3; }
    const fAge = ()=> (/50/.test(A.age||'')) ? .88 : (/40/.test(A.age||'')) ? .94 : (/30/.test(A.age||'')) ? .98 : 1.06;
    const fLife= ()=> (/Сидячая/.test(A.life||'')) ? .90 : (/Умеренно/.test(A.life||'')) ? 1.00 : 1.08;
    const fExp = ()=> (/Никогда/.test(A.exp||'')) ? .95 : (/Регулярно/.test(A.exp||'')) ? 1.08 : 1.00;
    function fBody(){ switch(A.body){ case 'slim':return .92; case 'avg':return 1.00; case 'large':return .96; case 'obese':return .92; default:return 1.00; } }
    function fSteps(){ const now=+A.steps||4000; const add=2000; const t=now+add; let boost=1+add/10000; if(now<3000)boost+=.08; if(now>9000)boost-=.06; return { f:Math.max(.95,Math.min(1.28,boost)), t }; }
    function fNutri(){ let f=1; if(A.nutri==='menu')f+=.22; else if(A.nutri==='plate')f+=.12; else f-=.12; f-=((A.bad||[]).length)*.03; f+=Math.min(((A.good||[]).length)*.02,.10); return Math.max(.7,Math.min(1.35,f)); }
    function fHealth(){ const h=new Set(A.health||[]); let f=1; if(h.has('Диабет')||h.has('Проблемы со щитовидкой')||h.has('Гипертония'))f-=.06; if(h.has('Боль в суставах'))f-=.04; return Math.max(.8,f); }
    function rate(){ let r=.5; const bmi=A.bmi||26; if(bmi>=30)r+=.08; else if(bmi<23)r-=.08; r*=fAge()*fLife()*fExp()*fBody()*fSteps().f*fNutri()*fHealth(); return Math.max(.25,Math.min(.9,+r.toFixed(2))); }

    function calculate(){
      const name=A.name?.trim()||'Друзья';
      const kg=goalKg(); const rt=rate();
      const wks=Math.max(4,Math.min(16,Math.ceil(kg/rt)));
      const t=fSteps().t;

      $('#rTitle').textContent=`${name}, ваш прогноз готов ✨`;
      animateNumber(12,wks,1400,v=>{ $('#nums').textContent=`−${kg} кг за ${v} недель`; });

      const rtText = rt.toLocaleString('ru-RU', {minimumFractionDigits:1, maximumFractionDigits:1});
      $('#rSub').innerHTML = `
        С тренировками ШАГАЙ ДОМА ⚡️ вы будете проходить
        <b>${t.toLocaleString('ru-RU')}</b> шагов каждый день!
        <br><span class="hint">Ориентировочный темп снижения веса:
        <b>~${rtText} кг/неделю</b> (среднее значение при соблюдении плана).</span>
      `;

      $('#sTitle').textContent=`${name}, присоединяйтесь к клубу «ШАГАЙ ДОМА» ⚡`;
      $('#sLead').innerHTML=`Чтобы прийти к цели <b>−${kg} кг</b> за <b>${wks} недель</b> — подключите готовые планы и поддержку. Первые изменения уже через 1–2 недели.`;
      $('#cta').href='https://walk-walk.ru/?utm_source=quiz&utm_medium=cta&utm_campaign=sd_weight_calc';

      show(idxBy('result'));
    }

    function animateNumber(a,b,d,cb){
      const start=performance.now(); const ease=t=>1-Math.pow(1-t,3);
      function frame(now){ const p=Math.min(1,(now-start)/d); cb(Math.round(a+(b-a)*ease(p))); if(p<1)requestAnimationFrame(frame); }
      requestAnimationFrame(frame);
    }
    $('#toCTA').onclick = ()=>show(idxBy('sale'));

    // Скрыть скелетон, когда видео готово
    const heroVideo = document.querySelector('video.hero-media');
    const heroSkel  = document.getElementById('heroSkel');
    function hideHeroSkel(){ heroSkel && heroSkel.classList.add('hide'); }
    heroVideo?.addEventListener('loadeddata', hideHeroSkel, {once:true});
    heroVideo?.addEventListener('canplay',    hideHeroSkel, {once:true});
    setTimeout(hideHeroSkel, 2000); // страховка на экономии трафика

    // На старте — к началу страницы
    requestAnimationFrame(()=>{ try{ scrollTo({top:0,behavior:'auto'});}catch(e){ scrollTo(0,0);} });
  </script>
</body>
</html>
