<!DOCTYPE html><html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ШАГАЙ ДОМА · Квиз‑калькулятор похудения</title>
  <meta name="description" content="Квиз с расчётом: за сколько недель шагательные тренировки помогут вам похудеть. 20–30 минут дома + +2000 шагов в день." />
  <style>
    :root{
      --brand-red:#CF2C02;/* кораллово‑красный */
      --brand-yellow:#FFBA08;/* ярко‑жёлтый */
      --brand-orange:#E85D04;/* оранжевый */
      --brand-gray:#D9D9D9;
      --bg:#fff;
      --text:#1a1a1a;
      --muted:#6b6b6b;
      --card:#ffffff;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
      --radius-lg:26px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Noto Sans", "Segoe UI Emoji";
      color:var(--text); background:linear-gradient(135deg,#fff 0%, #fff 40%, #fff6e0 100%);
      display:flex; align-items:center; justify-content:center;
    }
    .app{ width:min(960px, 100%); padding:clamp(12px,2vw,28px); }.card{ background:var(--card); border-radius:var(--radius-lg); box-shadow:var(--shadow);
       padding:clamp(16px,3vw,28px); position:relative; overflow:hidden }
.card h1, .card h2{ margin:0 0 .6rem 0; line-height:1.15 }
.lead{ color:var(--muted); font-size:1.05rem }

/* Top progress — tiny footprints */
.progress{ display:flex; gap:8px; align-items:center; margin:0 0 18px 0; padding:8px 4px }
.foot{ width:22px; height:22px; opacity:.25; transform:rotate(-18deg); transition:opacity .35s ease, transform .35s ease }
.foot.active{ opacity:1; transform:rotate(0deg) scale(1.08) }

/* Screen switch */
.screen{ display:none; animation:.45s fadeSlide ease both }
.screen.active{ display:block }
@keyframes fadeSlide{ from{ opacity:0; transform:translateY(16px) } to{ opacity:1; transform:translateY(0) } }

/* Inputs */
.grid{ display:grid; gap:14px }
.grid.cols-2{ grid-template-columns: 1fr 1fr }
.opt{ border:2px solid var(--brand-gray); border-radius:16px; padding:14px; cursor:pointer; background:#fff; transition:.2s; display:flex; align-items:center; gap:12px }
.opt input{ display:none }
.opt:hover{ transform:translateY(-2px) }
.opt.active{ border-color:var(--brand-orange); box-shadow:0 6px 16px rgba(232,93,4,.12) }
.opt .badge{ margin-left:auto; font-size:.85rem; color:#fff; background:var(--brand-orange); padding:.2rem .5rem; border-radius:999px; display:none }
.opt.active .badge{ display:inline-flex }

.slider-wrap{ padding:12px 6px 4px }
input[type="range"]{ width:100% }
.hint{ color:var(--muted); font-size:.9rem }

.row{ display:flex; gap:12px; flex-wrap:wrap }
.row .field{ flex:1 1 160px }
.label{ font-size:.9rem; color:var(--muted); margin-bottom:6px }
.text{ width:100%; border:2px solid var(--brand-gray); border-radius:12px; padding:12px 14px; font-size:1rem }

/* Buttons */
.actions{ display:flex; gap:10px; margin-top:18px }
.btn{ border:none; cursor:pointer; border-radius:14px; padding:12px 18px; font-weight:700; font-size:1rem; transition:.2s; display:inline-flex; align-items:center; gap:10px }
.btn-primary{ background:linear-gradient(135deg,var(--brand-red), var(--brand-orange)); color:#fff; box-shadow:0 10px 18px rgba(207,44,2,.25) }
.btn-primary:hover{ transform:translateY(-1px) }
.btn-ghost{ background:#fff; color:var(--text); border:2px solid var(--brand-gray) }

.divider{ height:1px; background:#eee; margin:14px 0 }

/* Loader / result */
.loader{ display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; text-align:center }
.loader .pulse{ width:68px; height:68px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #fff 0 30%, var(--brand-yellow) 31%);
                 box-shadow:0 0 0 0 rgba(255,186,8,.5); animation:pulse 1.6s infinite }
@keyframes pulse{ to{ box-shadow:0 0 0 26px rgba(255,186,8,0) } }

.counter{ font-size: clamp(30px, 7vw, 64px); font-weight:900; letter-spacing:-.02em }
.sub{ color:var(--muted) }

/* Silhouette */
.silhouette{ display:flex; align-items:center; justify-content:center; padding:12px 0 }
.silhouette svg{ width:min(320px, 80%); height:auto }

/* CTA card */
.cta{ background:linear-gradient(135deg, #fff 0%, #fff7e6 70%); border:2px dashed var(--brand-yellow); border-radius:20px; padding:18px }
.cta h3{ margin:.2rem 0 .6rem 0 }

/* Badges / chips */
.chips{ display:flex; flex-wrap:wrap; gap:8px }
.chip{ border:2px solid var(--brand-gray); border-radius:999px; padding:8px 12px; cursor:pointer; user-select:none; transition:.2s; background:#fff }
.chip.active{ border-color:var(--brand-orange); box-shadow:0 6px 16px rgba(232,93,4,.12) }

/* Sticky footer for mobile */
.sticky{ position:sticky; bottom:0; background:linear-gradient(0deg, #ffffff 70%, rgba(255,255,255,0) 100%); padding-top:10px }

/* Canvas for confetti */
#confetti{ position:fixed; inset:0; pointer-events:none }

/* Small */
@media (max-width:620px){
  .grid.cols-2{ grid-template-columns: 1fr }
}
/* HERO GIF */
.hero-wrap{ margin:0 0 12px 0; }
.hero-media, .hero-fallback{ display:block; width:100%; max-height:260px; object-fit:cover; border-radius:20px; box-shadow:var(--shadow); }
/* HERO GIF/VIDEO */
.hero-wrap{ margin:0 0 12px 0; }
.hero-media, .hero-fallback{ display:block; width:100%; max-height:260px; object-fit:cover; border-radius:20px; box-shadow:var(--shadow); }
/* Антиконфликт: включаем клики внутри наших экранов, даже если хост глобально навесил pointer-events:none для .active */
#screens .screen.active, #screens .opt.active, #screens .chip.active, #screens .foot.active { pointer-events:auto !important; }
.actions.sticky { z-index: 9; }
/* Edit mode (technical copy editing) */
.edit-toolbar{ position:fixed; top:12px; right:12px; z-index:9999; background:#fff; border:2px solid var(--brand-yellow); border-radius:12px; box-shadow:var(--shadow); padding:8px 10px; display:flex; gap:8px; align-items:center }
.edit-toolbar .btn{ padding:8px 12px; border-radius:10px; font-weight:700 }
.editable{ outline:2px dashed rgba(232,93,4,.55); outline-offset:4px; cursor:text }
body.edit-mode .editable:hover{ background:rgba(255,186,8,.12) }

  </style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="app">
    <div class="card">
      <!-- Progress footprints -->
      <div id="progress" class="progress" aria-label="Прогресс по вопросам"></div><!-- Screens -->
  <div id="screens">

    <!-- 0. Intro / Name -->
    <section class="screen active" data-id="intro">
      <!-- HERO GIF: замените src на свой путь/ссылку -->
      <figure class="hero-wrap">
        <video class="hero-media" autoplay muted loop playsinline preload="metadata" poster="intro_poster.jpg">
          <source src="intro.mp4" type="video/mp4" />
          <img class="hero-fallback" src="intro.gif" alt="ШАГАЙ ДОМА — вдохновляющий старт" />
        </video>
      </figure>
      <h1>Узнайте, за сколько недель шагательные тренировки помогут вам похудеть</h1>
      <p class="lead">Ответьте на несколько вопросов — и получите персональный расчёт + план. <strong>Это займёт 1–2 минуты.</strong></p>
      <div class="row" style="margin-top:8px">
        <div class="field">
          <div class="label">Как к вам обращаться?</div>
          <input id="name" class="text" placeholder="Например, Ирина" />
        </div>
      </div>
      <div class="actions sticky">
        <button class="btn btn-primary" id="startBtn" type="button" data-next>Поехали →</button>
      </div>
    </section>

    <!-- 1. Age -->
    <section class="screen" data-id="age">
      <h2>Ваш возраст</h2>
      <div class="grid cols-2" id="ageOptions"></div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 2. Body type -->
    <section class="screen" data-id="body">
      <h2>Телосложение сейчас</h2>
      <p class="hint">Для наглядности добавили иллюстрации.</p>
      <div class="grid cols-2" id="bodyOptions"></div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 2.5 Steps today -->
    <section class="screen" data-id="steps">
      <h2>Сколько шагов вы проходите сейчас в день?</h2>
      <div class="slider-wrap">
        <input id="stepsRange" type="range" min="0" max="25000" step="250" value="4000" />
        <div class="row" style="align-items:center; gap:14px; margin-top:6px">
          <div>Сейчас: <strong><span id="stepsVal">4000</span> шагов</strong></div>
          <div class="hint">Подсказка: посмотрите в приложении телефона/браслета</div>
        </div>
        <div class="hint" style="margin-top:6px">Мы добавим к вашему текущему уровню <strong>+2000 шагов/день</strong> — мягко и безопасно.</div>
      </div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 3. BMI calc -->
    <section class="screen" data-id="bmi">
      <h2>Давайте посчитаем ИМТ</h2>
      <p class="hint">Можно приблизительно — нам важен порядок величин.</p>
      <div class="row">
        <div class="field">
          <div class="label">Рост, см</div>
          <input id="height" type="number" inputmode="numeric" class="text" placeholder="Например, 165" />
        </div>
        <div class="field">
          <div class="label">Вес, кг</div>
          <input id="weight" type="number" inputmode="decimal" class="text" placeholder="Например, 72" />
        </div>
      </div>
      <div id="bmiInfo" class="hint" style="margin-top:10px"></div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 4. Lifestyle -->
    <section class="screen" data-id="life">
      <h2>Образ жизни</h2>
      <div class="grid cols-2" id="lifeOptions"></div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 5. Experience -->
    <section class="screen" data-id="exp">
      <h2>Опыт тренировок</h2>
      <div class="grid cols-2" id="expOptions"></div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 6. Goal -->
    <section class="screen" data-id="goal">
      <h2>Цель</h2>
      <div class="grid cols-2" id="goalOptions"></div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 7. Motivation -->
    <section class="screen" data-id="motivation">
      <h2>Что вас мотивирует больше всего?</h2>
      <div class="chips" id="motivationChips"></div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 8. Per week -->
    <section class="screen" data-id="perweek">
      <h2>Сколько готовы тренироваться в неделю?</h2>
      <div class="chips" id="perweekChips"></div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 9. Hardest -->
    <section class="screen" data-id="hard">
      <h2>Что сейчас даётся тяжелее всего?</h2>
      <div class="grid cols-2" id="hardOptions"></div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 10. Health -->
    <section class="screen" data-id="health">
      <h2>Есть ли состояния, которые важно учитывать?</h2>
      <div class="chips" id="healthChips"></div>
      <p class="hint" style="margin-top:8px">Если есть сомнения — перед началом тренировок проконсультируйтесь с врачом.</p>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 11. Nutrition plan -->
    <section class="screen" data-id="nutrition">
      <h2>Включим работу с питанием?</h2>
      <div class="grid cols-2" id="nutriOptions"></div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next>Далее</button>
      </div>
    </section>

    <!-- 12. Product calculator -->
    <section class="screen" data-id="foodcalc">
      <h2>Калькулятор продуктов</h2>
      <p class="hint">Выберите, что вы употребляете <strong>каждый день</strong> — это повлияет на прогноз.</p>
      <div class="chips" id="foodBad"></div>
      <div class="divider"></div>
      <div class="hint">А это — привычки, которые ускоряют результат. Отметьте, если они уже есть:</div>
      <div class="chips" id="foodGood" style="margin-top:8px"></div>
      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" data-next id="calcBtn">Рассчитать результат →</button>
      </div>
    </section>

    <!-- 13. Loading/result -->
    <section class="screen" data-id="loading">
      <div class="loader">
        <div class="pulse"></div>
        <h2 style="margin-top:16px">Прогноз загружается…</h2>
        <p class="hint">Мы учитываем ваш возраст, ИМТ, активность, шаги и питание.</p>
      </div>
    </section>

    <section class="screen" data-id="result">
      <h2 id="resultTitle">Готово!</h2>
      <div class="counter" id="resultNumbers">0 кг · 0 недель</div>
      <p class="sub" id="resultSub"></p>
      <div class="silhouette" id="silhouette"></div>

      <div class="cta" id="caseBlock" style="display:none"></div>

      <p class="hint" style="margin-top:10px">Средняя продолжительность тренировки — 20–30 минут дома. Ежедневная цель по шагам для вас: <strong id="stepsTarget">+2000 шагов к текущему уровню</strong>.</p>

      <div class="actions sticky">
        <button class="btn btn-ghost" data-prev>Назад</button>
        <button class="btn btn-primary" id="toCTA">Перейти к абонементу →</button>
      </div>
    </section>

    <!-- 14. Sales screen -->
    <section class="screen" data-id="sale">
      <h2 id="saleTitle">Присоединяйтесь к клубу «ШАГАЙ ДОМА» ⚡</h2>
      <p class="lead" id="saleLead"></p>
      <ul>
        <li>Домашние шагательные тренировки 20–30 минут</li>
        <li>Готовые планы на неделю + <em>меню‑конструктор</em></li>
        <li>Поддержка и мотивация в чате</li>
        <li>Без прыжков и сложной хореографии</li>
      </ul>
      <div class="actions">
        <a class="btn btn-primary" id="ctaLink" href="#" target="_blank" rel="noopener">Получить абонемент со скидкой</a>
        <button class="btn btn-ghost" data-prev>Назад</button>
      </div>
      <p class="hint" style="margin-top:10px">Важно: прогноз носит ознакомительный характер и не заменяет медицинские рекомендации.</p>
    </section>

  </div>
</div>

  </div>  <script>
  // Гарантируем инициализацию после загрузки DOM (важно для встраивания на платформы, которые переносят скрипт в <head>)
  window.addEventListener('load', function(){
    /* ————— Utilities ————— */
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
    const vibrate = (ms=12)=> { try{ if(navigator.vibrate) navigator.vibrate(ms) }catch(e){} };

    // Build tiny footprint SVG
    const footprintSVG = () => {
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('viewBox','0 0 64 64'); svg.classList.add('foot');
      svg.innerHTML = `<path d="M26 38c-7 1-8 8-6 13 3 6 12 7 18 3 5-4 7-12 3-16-3-3-9-1-15 0Z" fill="var(--brand-orange)"/>
        <circle cx="19" cy="21" r="5" fill="var(--brand-yellow)"/>
        <circle cx="28" cy="18" r="4" fill="var(--brand-yellow)"/>
        <circle cx="36" cy="18" r="3.8" fill="var(--brand-yellow)"/>
        <circle cx="44" cy="21" r="3.2" fill="var(--brand-yellow)"/>
        <circle cx="49" cy="26" r="2.6" fill="var(--brand-yellow)"/>`;
      return svg;
    };

    // Confetti (simple, no deps)
    const Confetti = (function(){
      const cnv = document.getElementById('confetti');
      const ctx = cnv.getContext('2d');
      let W, H, parts = [], running=false;
      const colors = ['#CF2C02','#E85D04','#FFBA08','#ffffff'];
      function resize(){ W = cnv.width = innerWidth; H = cnv.height = innerHeight; }
      function spawn(n=120){
        for(let i=0;i<n;i++){
          parts.push({
            x: Math.random()*W,
            y: -10 - Math.random()*H*0.5,
            r: 4+Math.random()*6,
            c: colors[(Math.random()*colors.length)|0],
            v: 1+Math.random()*3,
            a: Math.random()*Math.PI*2,
            s: 0.02 + Math.random()*0.04
          });
        }
      }
      function draw(){
        if(!running) return;
        ctx.clearRect(0,0,W,H);
        for(const p of parts){
          p.y += p.v; p.x += Math.sin(p.a+=p.s);
          ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
        }
        parts = parts.filter(p=>p.y < H+20);
        requestAnimationFrame(draw);
      }
      function burst(){ resize(); spawn(180); if(!running){ running=true; draw(); } setTimeout(()=>running=false, 1800); }
      addEventListener('resize', resize); resize();
      return { burst };
    })();

    /* ————— Quiz screens ————— */
    const screens = $$('#screens .screen');
    let idx = 0; // current screen index
    const progress = document.getElementById('progress');
    const TOTAL_STEPS = 15; // number of footprints
    const answers = JSON.parse(localStorage.getItem('sd_quiz')||'{}');

    // Build progress footprints
    for(let i=0;i<TOTAL_STEPS;i++){ progress.appendChild(footprintSVG()); }
    function renderProgress(){
      $$('.foot', progress).forEach((el,i)=>{
        el.classList.toggle('active', i <= idx);
      });
    }

    function show(i){
      screens[idx].classList.remove('active');
      idx = Math.max(0, Math.min(screens.length-1, i));
      screens[idx].classList.add('active');
      renderProgress();
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // Global nav buttons
    document.addEventListener('click', e=>{
      const next = e.target.closest('[data-next]');
      const prev = e.target.closest('[data-prev]');
      if(next){ vibrate(); goNext(); }
      if(prev){ vibrate(); show(idx-1); }
    });

    function goNext(){
      // simple required checks per screen
      const s = screens[idx].dataset.id;
      if(s==='age' && !answers.age) return shake(screens[idx]);
      if(s==='body' && !answers.body) return shake(screens[idx]);
      if(s==='bmi' && (!answers.height || !answers.weight)) return shake(screens[idx]);
      if(s==='life' && !answers.life) return shake(screens[idx]);
      if(s==='exp' && !answers.exp) return shake(screens[idx]);
      if(s==='goal' && !answers.goal) return shake(screens[idx]);
      if(s==='perweek' && !answers.perweek) return shake(screens[idx]);
      if(s==='health' && !answers.health) answers.health=[];
      if(s==='nutrition' && !answers.nutri) answers.nutri='no';
      show(idx+1);
    }

    function shake(el){ el.style.transform='translateX(0)'; el.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:280}); vibrate(25) }

    // Build options
    const ageOpts = ['18–29','30–39','40–49','50+'];
    buildOptions($('#ageOptions'), ageOpts, 'age');

    const bodyOpts = [
      {label:'Худощавое', key:'slim', svg: bodySVG(0.80)},
      {label:'Среднее', key:'avg', svg: bodySVG(1.00)},
      {label:'Крупное', key:'large', svg: bodySVG(1.12)},
      {label:'Избыточный вес', key:'obese', svg: bodySVG(1.26)},
    ];
    buildOptionCards($('#bodyOptions'), bodyOpts, 'body');

    const lifeOpts = ['Сидячая работа','Умеренно активная','Активная'];
    buildOptions($('#lifeOptions'), lifeOpts, 'life');

    const expOpts = ['Никогда не занималась','Иногда дома / по видео','Регулярно'];
    buildOptions($('#expOptions'), expOpts, 'exp');

    const goalOpts = ['Сбросить 3–5 кг','Сбросить 5–10 кг','10+ кг','Поддерживать фигуру / вернуть тонус'];
    buildOptions($('#goalOptions'), goalOpts, 'goal');

    const motiv = ['Для здоровья','Для внешности','Для энергии и лёгкости','Для уверенности в себе'];
    buildChips($('#motivationChips'), motiv, 'motivation', true);

    buildChips($('#perweekChips'), ['2 раза','3 раза','4–5 раз','Каждый день 20–30 мин'], 'perweek');

    const hardOpts = ['Долгая прогулка утомляет','Каждый пролёт по лестнице — испытание','Стыдно включаться в активные игры','Прыжки','Ничего из этого'];
    buildOptions($('#hardOptions'), hardOpts, 'hard');

    const health = ['Диабет','Проблемы со щитовидкой','Гипертония','Боль в суставах','Беременность','Нет'];
    buildChips($('#healthChips'), health, 'health', true);

    const nutri = [
      {label:'Буду питаться по меню‑конструктору в клубе', key:'menu'},
      {label:'Хочу научиться правильно составлять тарелку', key:'plate'},
      {label:'Нет, пока без питания', key:'no'}
    ];
    buildOptionCards($('#nutriOptions'), nutri.map(n=>({label:n.label, key:n.key})), 'nutri');

    const foodBad = ['Сладкая газировка','Выпечка','Фастфуд','Колбаса/сосиски','Сыр 45%+','Ночные перекусы','Алкоголь чаще 2 р/нед','Сладкий чай/кофе','Очень солёная пища'];
    const foodGood = ['1.5–2 л воды','Овощи 400 г/день','Фрукты ежедневно','Белок в каждом приёме пищи','10–20 мин растяжки','8 000+ шагов уже сейчас'];
    buildChips($('#foodBad'), foodBad, 'foodBad', true);
    buildChips($('#foodGood'), foodGood, 'foodGood', true);

    // Steps slider
    const stepsRange = document.getElementById('stepsRange');
    const stepsVal = document.getElementById('stepsVal');
    stepsRange.addEventListener('input', e=>{ stepsVal.textContent = e.target.value; answers.stepsNow = +e.target.value; persist(); });
    if(answers.stepsNow){ stepsRange.value = answers.stepsNow; stepsVal.textContent = answers.stepsNow; }

    // Name field
    const nameInput = document.getElementById('name');
    nameInput.addEventListener('input', e=>{ answers.name = e.target.value.trim(); persist(); });
    if(answers.name) nameInput.value = answers.name;

    // BMI live helper
    const h = document.getElementById('height');
    const w = document.getElementById('weight');
    const bmiInfo = document.getElementById('bmiInfo');
    function updateBMI(){
      const height = parseFloat(h.value); const weight = parseFloat(w.value);
      if(height>0 && weight>0){
        answers.height = height; answers.weight = weight; persist();
        const m = height/100; const bmi = +(weight/(m*m)).toFixed(1);
        answers.bmi = bmi; persist();
        bmiInfo.innerHTML = `Ваш ИМТ: <strong>${bmi}</strong> — ${bmiBand(bmi)}. <br/><span class="hint">ИМТ помогает приблизительно оценить, с какой скорости начинать. Это не диагноз.</span>`;
      }
    }
    h.addEventListener('input', updateBMI); w.addEventListener('input', updateBMI);
    if(answers.height){ h.value = answers.height; } if(answers.weight){ w.value = answers.weight; updateBMI(); }

    // Persist
    function persist(){ localStorage.setItem('sd_quiz', JSON.stringify(answers)); }

    // Build helpers
    function buildOptions(root, arr, key){
      root.innerHTML = '';
      arr.forEach(label=>{
        const div = document.createElement('label'); div.className='opt';
        div.innerHTML = `<input type="radio" name="${key}"><span>${label}</span><span class="badge">выбрано</span>`;
        root.appendChild(div);
        div.addEventListener('click',()=>{
          $$('.opt', root).forEach(o=>o.classList.remove('active'));
          div.classList.add('active'); answers[key]=label; vibrate(); persist();
        });
        if(answers[key]===label) div.classList.add('active');
      });
    }

    function buildOptionCards(root, arr, key){
      root.innerHTML='';
      arr.forEach(obj=>{
        const div = document.createElement('label'); div.className='opt';
        div.innerHTML = `${obj.svg||''}<span>${obj.label}</span><span class="badge">выбрано</span>`;
        root.appendChild(div);
        div.addEventListener('click',()=>{
          $$('.opt', root).forEach(o=>o.classList.remove('active'));
          div.classList.add('active'); answers[key]=obj.key||obj.label; vibrate(); persist();
        });
        if(answers[key]===(obj.key||obj.label)) div.classList.add('active');
      });
    }

    function buildChips(root, arr, key, multi=false){
      root.innerHTML='';
      const current = new Set(Array.isArray(answers[key])?answers[key]: (answers[key]?[answers[key]]:[]) );
      arr.forEach(label=>{
        const chip = document.createElement('button'); chip.type='button'; chip.className='chip'; chip.textContent=label;
        if(current.has(label)) chip.classList.add('active');
        chip.addEventListener('click',()=>{
          chip.classList.toggle('active'); vibrate(8);
          if(multi){
            const sel = chipsSelection(root);
            answers[key] = sel; persist();
          }else{
            // single
            $$('.chip', root).forEach(c=>c.classList.remove('active'));
            chip.classList.add('active'); answers[key]=label; persist();
          }
        });
        root.appendChild(chip);
      });
      function chipsSelection(container){ return $$('.chip.active', container).map(c=>c.textContent); }
    }

    // Simple body silhouette SVG (waist width controlled by factor)
    function bodySVG(factor=1){
      const width = 54*factor; // waist area width
      return `<svg width="42" height="56" viewBox="0 0 84 112" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <ellipse cx="42" cy="16" rx="12" ry="12" fill="#FFD9A6"/>
        <path d="M14 104c6-18 4-30 16-42-12-14-8-30 4-38h16c12 8 16 24 4 38 12 12 10 24 16 42H14Z" fill="#FFE9C7" stroke="#F1C48B" stroke-width="2"/>
        <rect x="${42-width/2}" y="52" width="${width}" height="18" rx="9" fill="#FFC89D" opacity=".6"/>
      </svg>`
    }

    // Calculate button
    $('#calcBtn').addEventListener('click', ()=>{
      show(idx+1); // to loading
      setTimeout(() => { calculateResult(); }, 900);
    });

    function bmiBand(b){
      if(b<18.5) return 'ниже нормы';
      if(b<25) return 'норма';
      if(b<30) return 'избыточная масса';
      return 'ожирение';
    }

    function goalKg(){
      const g = answers.goal || '';
      if(g.includes('3–5')) return 4;
      if(g.includes('5–10')) return 8;
      if(g.includes('10+')) return 12;
      return 3; // поддержание => мягкая цель
    }

    function perWeekFactor(){
      const p = answers.perweek||'';
      if(p.includes('Каждый день')) return 1.2;
      if(p.includes('4–5')) return 1.15;
      if(p.includes('3')) return 1.05;
      return 0.95; // 2 раза
    }

    function lifeFactor(){
      const l = answers.life||'';
      if(l.includes('Сидячая')) return 0.9;
      if(l.includes('Умеренно')) return 1.0;
      return 1.08; // Активная
    }

    function ageFactor(){
      const a = answers.age||'';
      if(a.includes('50')) return 0.88;
      if(a.includes('40')) return 0.94;
      if(a.includes('30')) return 0.98;
      return 1.06; // 18–29
    }

    function expFactor(){
      const e = answers.exp||'';
      if(e.includes('Никогда')) return 0.95;
      if(e.includes('Регулярно')) return 1.08;
      return 1.0;
    }

    function bodyAdj(){
      const b = answers.body||'';
      if(b==='slim') return 0.92;
      if(b==='avg') return 1.0;
      if(b==='large') return 0.96;
      if(b==='obese') return 0.92; // начнём мягче, но темп устойчивый
      return 1.0;
    }

    function stepsFactor(){
      const now = +answers.stepsNow||4000;
      const added = 2000; // модель из проектного ТЗ
      const target = now + added;
      // Чем меньше база, тем сильнее прирост к расходу, но в разумных пределах
      let boost = 1.0 + (added/10000); // +0.2 при +2000
      if(now<3000) boost += 0.08;
      if(now>9000) boost -= 0.06;
      return {factor: Math.max(0.95, Math.min(1.28, boost)), target};
    }

    function nutritionFactor(){
      let f = 1.0;
      if(answers.nutri==='menu') f += 0.22;
      else if(answers.nutri==='plate') f += 0.12;
      else f -= 0.12;
      const bad = new Set(answers.foodBad||[]);
      const good = new Set(answers.foodGood||[]);
      f -= bad.size * 0.03;
      f += Math.min(good.size*0.02, 0.10);
      return Math.max(0.7, Math.min(1.35, f));
    }

    function healthFactor(){
      const h = new Set(answers.health||[]);
      let f = 1.0;
      if(h.has('Диабет')||h.has('Проблемы со щитовидкой')||h.has('Гипертония')) f -= 0.06; // осторожнее темп
      if(h.has('Боль в суставах')) f -= 0.04;
      return Math.max(0.8, f);
    }

    function calcRateKgPerWeek(){
      // Базовая безопасная скорость: 0.5 кг/нед
      let rate = 0.5;
      // BMI adjust
      const bmi = answers.bmi || 26;
      if(bmi>=30) rate += 0.08; else if(bmi<23) rate -= 0.08;
      rate *= ageFactor();
      rate *= lifeFactor();
      rate *= expFactor();
      rate *= bodyAdj();
      const sF = stepsFactor().factor; rate *= sF;
      rate *= nutritionFactor();
      rate *= healthFactor();
      // Clamp
      rate = Math.max(0.25, Math.min(0.9, rate));
      return +rate.toFixed(2);
    }

    function calculateResult(){
      const name = answers.name?.trim() || 'Друзья';
      const kgGoal = goalKg();
      const rate = calcRateKgPerWeek();
      const weeks = Math.max(4, Math.min(16, Math.ceil(kgGoal / rate)));
      const kg = kgGoal; // показываем цель как достижимую при этом сроке
      const {target} = stepsFactor();

      // Animate numbers
      $('#resultTitle').textContent = `${name}, ваш прогноз готов ✨`;
      showScreenResult(kg, weeks);
      $('#resultSub').innerHTML = `При темпе <strong>${rate} кг/нед</strong> и ежедневных шагах <strong>${target.toLocaleString('ru-RU')}</strong>.`;
      $('#stepsTarget').textContent = `${target.toLocaleString('ru-RU')} шагов/день`;

      // Silhouette morph (приблизительно)
      const height = answers.height || 165; const weight = answers.weight || 72;
      const afterWeight = Math.max(40, weight - kg);
      const m = height/100;
      const bmiAfter = afterWeight/(m*m);
      // map BMI 19..32 -> factor 0.78..1.22
      const factor = mapClamp(bmiAfter, 19, 32, 0.78, 1.22);
      $('#silhouette').innerHTML = bodySVG(factor);

      // Case block
      const caseBlock = $('#caseBlock');
      const cases = [
        {cond: kg>=10, html:`<h3>Как у Анны: −12 кг за 10 недель</h3><p>Старт с 4000 шагов → довели до 9000 и добавили 20‑минутные тренировки. Главное — мягко и регулярно. У вас очень похожий профиль.</p>`},
        {cond: kg>=6 && kg<10, html:`<h3>Как у Марины: −7 кг за 8 недель</h3><p>Комбинация шагательных + меню‑конструктор. 25 минут в день и +2000 шагов к базе.</p>`},
        {cond: kg<6, html:`<h3>Как у Светланы: −4.5 кг за 6 недель</h3><p>Без голодовок и прыжков. Мягко увеличили шаги и подключили лёгкие силовые блоки.</p>`},
      ];
      const picked = cases.find(c=>c.cond);
      caseBlock.style.display = 'block';
      caseBlock.innerHTML = picked.html + `<p class="hint" style="margin-top:6px">* Кейсы основаны на реальном опыте участниц клуба. Результаты индивидуальны.</p>`;

      // Fire confetti
      Confetti.burst();

      // Prepare sale text
      const saleName = answers.name?.trim() ? `${answers.name}, ` : '';
      $('#saleTitle').textContent = `${saleName}присоединяйтесь к клубу «ШАГАЙ ДОМА» ⚡`;
      $('#saleLead').innerHTML = `Чтобы прийти к цели <strong>≈${kg} кг</strong> за <strong>${weeks} недель</strong>, подключите готовые планы и поддержку — первые изменения заметны уже через 1–2 недели.`;
      const utm = `?utm_source=quiz&utm_medium=cta&utm_campaign=sd_weight_calc`;
      $('#ctaLink').href = 'https://walk-walk.ru/' + utm; // ← замените на лендинг/офер

      // Move to result screen
      show(getIndexById('result'));
    }

    function showScreenResult(kg, weeks){
      const el = $('#resultNumbers');
      // Start count from visually engaging numbers
      animateNumber(12, weeks, 1500, v=>{
        el.textContent = `${kg} кг · ${v} недель`;
      }, true);
    }

    function animateNumber(from, to, dur, cb, integer=true){
      const start = performance.now();
      function frame(now){
        const p = Math.min(1, (now-start)/dur);
        const val = from + (to-from)*easeOutCubic(p);
        const out = integer ? Math.round(val) : +val.toFixed(1);
        cb(out);
        if(p<1) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }
    const easeOutCubic = t=>1-Math.pow(1-t,3);

    function getIndexById(id){ return screens.findIndex(s=>s.dataset.id===id); }

    // Change screens with preload of loading effect on calc
    function mapClamp(v, inMin, inMax, outMin, outMax){
      const cl = Math.max(inMin, Math.min(inMax, v));
      const r = (cl-inMin)/(inMax-inMin); return outMin + r*(outMax-outMin);
    }

    // Hook result → sale
    $('#toCTA').addEventListener('click', ()=>{
      show(getIndexById('sale'));
    });

    // Initialize
    renderProgress();

    /* ————— Accessibility helpers ————— */
    document.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowRight') { goNext(); }
      if(e.key==='ArrowLeft') { show(idx-1); }
    });
      // Дополнительная подстраховка для стартовой кнопки
    const startBtn = document.getElementById('startBtn');
    if(startBtn){ startBtn.addEventListener('click', ()=>{ /* если глобальный делегат кликов не сработал */ try{ if(typeof goNext==='function'){ goNext(); } }catch(e){} }); }
  });
</script>
  
  <!-- Optional embedded copy; paste your JSON here when публикуете -->
  <script id="sd-copy" type="application/json">{}</script>

  <script>
    // ——— Technical edit mode for texts ———
    (function(){
      const qs = new URLSearchParams(location.search);
      const EDIT = qs.get('edit')==='1' || localStorage.getItem('sd_edit')==='1';
      if(qs.get('reset_copy')==='1'){ localStorage.removeItem('sd_copy'); }

      // 1) Assign stable data-edit-id to text elements
      const WL = '#screens h1, #screens h2, #screens p, #screens .lead, #screens .hint, #screens button, #saleTitle, #saleLead, #resultTitle, #toCTA';
      const nodes = Array.from(document.querySelectorAll(WL)).filter(n=> n && n.textContent.trim().length && !n.classList.contains('counter'));
      nodes.forEach((el, i)=>{ if(!el.dataset.editId){ el.dataset.editId = 't'+i; } });

      // 2) Load copy from embedded <script id="sd-copy"> and localStorage
      function loadEmbedded(){
        try{ const el = document.getElementById('sd-copy'); if(!el) return {}; return JSON.parse(el.textContent || '{}'); }catch(e){ return {}; }
      }
      function loadStored(){ try{ return JSON.parse(localStorage.getItem('sd_copy')||'{}'); }catch(e){ return {}; } }
      const COPY = Object.assign({}, loadEmbedded(), loadStored());

      // 3) Apply copy
      function applyCopy(){
        Object.entries(COPY).forEach(([id,txt])=>{
          const el = document.querySelector('[data-edit-id="'+id+'"]');
          if(el && typeof txt==='string'){ el.textContent = txt; }
        });
      }
      applyCopy();

      // 4) If EDIT, enable contenteditable UI
      if(EDIT){
        document.body.classList.add('edit-mode');
        nodes.forEach(el=>{
          el.contentEditable = 'true';
          el.classList.add('editable');
          el.addEventListener('input', ()=>{ COPY[el.dataset.editId] = el.textContent; });
          el.addEventListener('blur',  ()=>{ localStorage.setItem('sd_copy', JSON.stringify(COPY)); });
        });
        // Toolbar
        const bar = document.createElement('div');
        bar.className = 'edit-toolbar';
        bar.innerHTML = `
          <button class="btn btn-ghost" id="edSave" type="button">Сохранить</button>
          <button class="btn btn-primary" id="edCopy" type="button">Скопировать JSON</button>
          <button class="btn btn-ghost" id="edEmbed" type="button">Сформировать &lt;script id=\"sd-copy\"&gt;</button>
          <button class="btn btn-ghost" id="edExit" type="button">Выйти</button>
        `;
        document.body.appendChild(bar);
        const save = ()=> localStorage.setItem('sd_copy', JSON.stringify(COPY));
        bar.querySelector('#edSave').onclick = save;
        bar.querySelector('#edCopy').onclick = ()=>{
          const txt = JSON.stringify(COPY, null, 2);
          navigator.clipboard?.writeText(txt).catch(()=>{});
          alert('JSON скопирован в буфер обмена');
        };
        bar.querySelector('#edEmbed').onclick = ()=>{
          const scriptTag = `<script id=\"sd-copy\" type=\"application/json\">
${JSON.stringify(COPY, null, 2)}
<\/script>`;
          navigator.clipboard?.writeText(scriptTag).catch(()=>{});
          alert('Вставьте содержимое скрипта в HTML вместо пустого { }');
        };
        bar.querySelector('#edExit').onclick = ()=>{
          localStorage.setItem('sd_edit','');
          const u = new URL(location.href); u.searchParams.delete('edit'); location.href = u.toString();
        };
        // Persist flag
        localStorage.setItem('sd_edit','1');
      }
    })();
  </script>
</body>
